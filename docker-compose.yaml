services:
  kv:
    container_name: kv-${CUSTOMER_ID}
    image: 'ghcr.io/denoland/denokv:latest'
    command: '--sqlite-path /data/denokv.sqlite serve --access-token ${DENO_KV_ACCESS_TOKEN}'
    volumes:
      - '/opt/coolify/customers/${CUSTOMER_ID}/kv:/data'
    expose:
      - 4512
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped
    networks:
      - customer-net

  server:
    container_name: server-${CUSTOMER_ID}
    build: .
    expose:
      - 8082
      - 8081
    environment:
      DENO_KV_URL: 'http://kv-${CUSTOMER_ID}:4512'
      DENO_KV_ACCESS_TOKEN: '${DENO_KV_ACCESS_TOKEN}'
      DENORITE_ALLOWED_ORIGIN: '${DENORITE_ALLOWED_ORIGIN}'
      DENORITE_SERVER_SECRET: '${DENORITE_SERVER_SECRET}'
      DENORITE_JWT_SECRET: '${DENORITE_JWT_SECRET}'
      COOLIFY_URL: 'https://app-${CUSTOMER_ID}.cou.ai:8082,https://api-${CUSTOMER_ID}.cou.ai:8081'
      COOLIFY_FQDN: 'app-${CUSTOMER_ID}.cou.ai:8082,api-${CUSTOMER_ID}.cou.ai:8081'
    volumes:
      - '/opt/coolify/customers/${CUSTOMER_ID}/modules:/app/modules'
    depends_on:
      - kv
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    networks:
      - customer-net

networks:
  customer-net:
    driver: bridge
